{"version":3,"sources":["../../src/Repository/SqliteCrawlStatesRepository.js"],"names":["SqliteCrawlStatesRepository","constructor","projectFolder","createIndexFolder","db","Database","databaseFile","insertUrlsStmt","prepare","insertUrlsAttemptedStmt","insertUrlsPoolStmt","initUrlsPool","urls","run","forEach","url","urlsPoolSize","result","get","size","urlsSize","addPoolUrl","findAttemptedUrls","addUrl","name","findAllUrls","all","checkUrl","replace","query","popPoolUrl","projectsPathUrls","tempDbFile","__filename"],"mappings":"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","sourcesContent":["// @flow\r\nimport {existsSync, mkdirSync, copyFileSync} from \"fs\";\r\nimport {join, dirname} from \"path\";\r\nimport Database from \"better-sqlite3\";\r\n\r\nimport Url from \"../Model/Url\";\r\n\r\n/**\r\n * Read and write the current crawl state to file.\r\n */\r\nexport default class SqliteCrawlStatesRepository {\r\n    projectFolder: string;\r\n    databaseFile: string;\r\n    db: Database;\r\n    insertUrlsStmt: any;\r\n    insertUrlsAttemptedStmt: any;\r\n    insertUrlsPoolStmt: any;\r\n\r\n    constructor(projectFolder: string) {\r\n        this.projectFolder = projectFolder;\r\n\r\n        this.createIndexFolder();\r\n        this.db = new Database(this.databaseFile, {});\r\n\r\n        this.insertUrlsStmt = this.db.prepare(\"INSERT INTO urls VALUES (?, ?)\");\r\n        this.insertUrlsAttemptedStmt = this.db.prepare(\r\n            \"INSERT INTO urls_attempted VALUES (?)\"\r\n        );\r\n        this.insertUrlsPoolStmt = this.db.prepare(\r\n            \"INSERT INTO urls_pool VALUES (?)\"\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Truncate and initialize the pool.\r\n     */\r\n    initUrlsPool(urls: string[]) {\r\n        this.db.prepare(\"DELETE FROM urls_pool\").run();\r\n        this.db.prepare(\"VACUUM\").run();\r\n        urls.forEach(url => this.insertUrlsPoolStmt.run([url]));\r\n    }\r\n\r\n    /**\r\n     * Get the number of urls in the urls pool.\r\n     */\r\n    urlsPoolSize(): number {\r\n        const result = this.db\r\n            .prepare(\"SELECT COUNT(*) as size FROM urls_pool\")\r\n            .get();\r\n        return result.size;\r\n    }\r\n\r\n    /**\r\n     * Get the number of urls found.\r\n     */\r\n    urlsSize(): number {\r\n        return this.db.prepare(\"SELECT COUNT(*) as size FROM urls\").get().size;\r\n    }\r\n\r\n    /**\r\n     * Add a url that needs to be crawled.\r\n     */\r\n    addPoolUrl(url: string) {\r\n        if (this.findAttemptedUrls(url) === 0) {\r\n            this.insertUrlsPoolStmt.run([url]);\r\n            this.insertUrlsAttemptedStmt.run([url]);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Add a found url.\r\n     */\r\n    addUrl(url: Url) {\r\n        this.insertUrlsStmt.run([url.url, url.name]);\r\n    }\r\n\r\n    /**\r\n     * Find all the urls found during the crawl.\r\n     */\r\n    findAllUrls(): Url[] {\r\n        return this.db.prepare(\"SELECT * FROM urls\").all();\r\n    }\r\n\r\n    /**\r\n     * Find the number of attempted urls.\r\n     */\r\n    findAttemptedUrls(url: string): number {\r\n        // Remove protocol and trailing slash to avoid duplicate indexing.\r\n        const checkUrl = url.replace(/(https|http)/i, \"\");\r\n        const query = `SELECT COUNT(*) as size FROM urls_attempted WHERE url='http${checkUrl}' OR url='https${checkUrl}'`;\r\n        const result = this.db.prepare(query).get();\r\n        return result.size;\r\n    }\r\n\r\n    /**\r\n     * Pop a url off the urls pools and return.\r\n     */\r\n    popPoolUrl(): string {\r\n        const url = this.db.prepare(\"SELECT * FROM urls_pool LIMIT 1\").get();\r\n        this.db.prepare(\"DELETE FROM urls_pool WHERE url = ?\").run([url.url]);\r\n        return url.url;\r\n    }\r\n\r\n    /**\r\n     * Creates the urls folder in the project if it doesn't exist.\r\n     */\r\n    createIndexFolder() {\r\n        let projectsPathUrls = join(this.projectFolder, \"urls\");\r\n        if (!existsSync(projectsPathUrls)) {\r\n            mkdirSync(projectsPathUrls);\r\n        }\r\n\r\n        this.databaseFile = join(projectsPathUrls, \"crawl_state.sqlite\");\r\n\r\n        if (!existsSync(this.databaseFile)) {\r\n            let tempDbFile = join(\r\n                dirname(__filename),\r\n                \"../Assets/crawl_state.sqlite\"\r\n            );\r\n            copyFileSync(tempDbFile, this.databaseFile);\r\n        }\r\n    }\r\n}\r\n"],"file":"SqliteCrawlStatesRepository.js"}