{"version":3,"sources":["../../src/Repository/SitemapRepository.js"],"names":["SitemapRepository","constructor","initialSitemap","initialUrl","sitemaps","urls","findAllPages","progress","length","push","Promise","resolve","reject","parseSiteMap","url","pop","Progress","Url","done","res","xml","getBody","xml2js","parseString","err","result","forEach","entry"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AACA;;;;;;AAEA;;;AAGe,MAAMA,iBAAN,CAAwB;AACnC;;;;AAIA;;;;AAIA;;;;AAIA;;;;AAIA;;;;AAIA;;;;AAKA;;;AAGAC,EAAAA,WAAW,CAACC,cAAD,EAAyB;AAChC,SAAKC,UAAL,GAAkBD,cAAlB;AACA,SAAKE,QAAL,GAAgB,EAAhB;AACA,SAAKC,IAAL,GAAY,EAAZ;AACH;AAED;;;;;AAGAC,EAAAA,YAAY,CAACC,QAAD,EAA6C;AACrD,SAAKA,QAAL,GAAgBA,QAAhB;;AACA,QAAI,KAAKH,QAAL,CAAcI,MAAd,KAAyB,CAA7B,EAAgC;AAC5B,WAAKJ,QAAL,CAAcK,IAAd,CAAmB,KAAKN,UAAxB;AACH;;AACD,WAAO,IAAIO,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACpC,WAAKD,OAAL,GAAeA,OAAf;AACA,WAAKC,MAAL,GAAcA,MAAd;AACA,WAAKC,YAAL;AACH,KAJM,CAAP;AAKH;AAED;;;;;;AAIAA,EAAAA,YAAY,GAAG;AACX,QAAIC,GAAG,GAAG,KAAKV,QAAL,CAAcW,GAAd,EAAV;AACA,SAAKR,QAAL,CAAc,IAAIS,iBAAJ,CAAa,IAAIC,YAAJ,CAAQH,GAAR,CAAb,EAA2B,IAA3B,EAAiC,IAAjC,EAAuC,KAAKV,QAAL,CAAcI,MAArD,EAA6D,KAAKH,IAAL,CAAUG,MAAvE,CAAd;AACA,8BAAQ,KAAR,EAAeM,GAAf,EAAoBI,IAApB,CAAyBC,GAAG,IAAI;AAC5B,UAAIC,GAAG,GAAGD,GAAG,CAACE,OAAJ,CAAY,MAAZ,CAAV;AACAC,MAAAA,MAAM,CAACC,WAAP,CAAmBH,GAAnB,EAAwB,CAACI,GAAD,EAAMC,MAAN,KAAiB;AACrC,YAAIA,MAAM,CAAC,QAAD,CAAV,EAAsB;AAClBA,UAAAA,MAAM,CAAC,QAAD,CAAN,CAAiB,KAAjB,EAAwBC,OAAxB,CAAgCC,KAAK,IAAI;AACrC,gBAAIb,GAAG,GAAG,IAAIG,YAAJ,CAAQU,KAAK,CAAC,KAAD,CAAL,CAAa,CAAb,CAAR,CAAV;AACA,iBAAKtB,IAAL,CAAUI,IAAV,CAAeK,GAAf;AACH,WAHD;;AAIA,cAAI,KAAKV,QAAL,CAAcI,MAAd,KAAyB,CAA7B,EAAgC;AAC5B,iBAAKG,OAAL,CAAa,KAAKN,IAAlB;AACH,WAFD,MAEO;AACH,iBAAKQ,YAAL;AACH;AACJ;;AACD,YAAIY,MAAM,CAAC,cAAD,CAAV,EAA4B;AACxBA,UAAAA,MAAM,CAAC,cAAD,CAAN,CAAuB,SAAvB,EAAkCC,OAAlC,CAA0CC,KAAK,IAAI;AAC/C,iBAAKvB,QAAL,CAAcK,IAAd,CAAmBkB,KAAK,CAAC,KAAD,CAAL,CAAa,CAAb,CAAnB;AACH,WAFD;AAGA,eAAKd,YAAL;AACH;AACJ,OAlBD;AAmBH,KArBD;AAsBH;;AA/EkC","sourcesContent":["// @flow\nimport request from \"then-request\";\nimport * as xml2js from \"xml2js\";\nimport Progress from \"../Model/Progress.js\";\nimport Url from \"../Model/Url.js\";\n\n/**\n * Get all the urls from the sitemaps.\n */\nexport default class SitemapRepository {\n    /**\n     * The initial sitemap url.\n     */\n    initialUrl: string;\n    /**\n     * Array of the site maps to search. This list gets popped and will be empty.\n     */\n    sitemaps: string[];\n    /**\n     * Array of all the urls found.\n     */\n    urls: Url[];\n    /**\n     * Where the scan at?\n     */\n    progress: Progress => void;\n    /**\n     * Called with a list of urls that were found on the sitemap.\n     */\n    resolve: (Url[]) => void;\n    /**\n     * Report a problem.\n     */\n    reject: () => void;\n\n    /**\n     * Build a sitemap repository\n     */\n    constructor(initialSitemap: string) {\n        this.initialUrl = initialSitemap;\n        this.sitemaps = [];\n        this.urls = [];\n    }\n\n    /**\n     * Find all the urls on a sitemap.\n     */\n    findAllPages(progress: Progress => void): Promise<Url[]> {\n        this.progress = progress;\n        if (this.sitemaps.length === 0) {\n            this.sitemaps.push(this.initialUrl);\n        }\n        return new Promise((resolve, reject) => {\n            this.resolve = resolve;\n            this.reject = reject;\n            this.parseSiteMap();\n        });\n    }\n\n    /**\n     * Gets the sitemap, if there are more sitemaps it will add them to the list\n     * else, just adds the urls to the urls array.\n     */\n    parseSiteMap() {\n        let url = this.sitemaps.pop();\n        this.progress(new Progress(new Url(url), null, null, this.sitemaps.length, this.urls.length));\n        request(\"GET\", url).done(res => {\n            let xml = res.getBody(\"utf8\");\n            xml2js.parseString(xml, (err, result) => {\n                if (result[\"urlset\"]) {\n                    result[\"urlset\"][\"url\"].forEach(entry => {\n                        let url = new Url(entry[\"loc\"][0]);\n                        this.urls.push(url);\n                    });\n                    if (this.sitemaps.length === 0) {\n                        this.resolve(this.urls);\n                    } else {\n                        this.parseSiteMap();\n                    }\n                }\n                if (result[\"sitemapindex\"]) {\n                    result[\"sitemapindex\"][\"sitemap\"].forEach(entry => {\n                        this.sitemaps.push(entry[\"loc\"][0]);\n                    });\n                    this.parseSiteMap();\n                }\n            });\n        });\n    }\n}\n"],"file":"SitemapRepository.js"}