{"version":3,"sources":["../../src/Repository/SitemapRepository.js"],"names":["SitemapRepository","constructor","initialSitemap","initialUrl","sitemaps","urls","findAllPages","progress","length","push","Promise","resolve","reject","parseSiteMap","url","pop","Progress","Url","done","res","xml","getBody","err","result","forEach","entry"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AACA;;;;AAEA;;;AAGe,MAAMA,iBAAN,CAAwB;AACrC;;;;AAIA;;;;AAIA;;;;AAWA;;;AAGAC,EAAAA,WAAW,CAACC,cAAD,EAAyB;AAClC,SAAKC,UAAL,GAAkBD,cAAlB;AACA,SAAKE,QAAL,GAAgB,EAAhB;AACA,SAAKC,IAAL,GAAY,EAAZ;AACD;AAED;;;;;AAGAC,EAAAA,YAAY,CAACC,QAAD,EAA6C;AACvD,SAAKA,QAAL,GAAgBA,QAAhB;;AACA,QAAI,KAAKH,QAAL,CAAcI,MAAd,KAAyB,CAA7B,EAAgC;AAC9B,WAAKJ,QAAL,CAAcK,IAAd,CAAmB,KAAKN,UAAxB;AACD;;AACD,WAAO,IAAIO,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,WAAKD,OAAL,GAAeA,OAAf;AACA,WAAKC,MAAL,GAAcA,MAAd;AACA,WAAKC,YAAL;AACD,KAJM,CAAP;AAKD;AAED;;;;;;AAIAA,EAAAA,YAAY,GAAG;AACb,QAAIC,GAAG,GAAG,KAAKV,QAAL,CAAcW,GAAd,EAAV;AACA,SAAKR,QAAL,CAAc,IAAIS,iBAAJ,CAAa,IAAIC,YAAJ,CAAQH,GAAR,CAAb,EAA2B,IAA3B,EAAiC,KAAKV,QAAL,CAAcI,MAA/C,EAAuD,KAAKH,IAAL,CAAUG,MAAjE,CAAd;AACA,8BAAQ,KAAR,EAAeM,GAAf,EAAoBI,IAApB,CAAyBC,GAAG,IAAI;AAC9B,UAAIC,GAAG,GAAGD,GAAG,CAACE,OAAJ,CAAY,MAAZ,CAAV;AACA,+BAAYD,GAAZ,EAAiB,CAACE,GAAD,EAAMC,MAAN,KAAiB;AAChC,YAAIA,MAAM,CAAC,QAAD,CAAV,EAAsB;AACpBA,UAAAA,MAAM,CAAC,QAAD,CAAN,CAAiB,KAAjB,EAAwBC,OAAxB,CAAgCC,KAAK,IAAI;AACvC,gBAAIX,GAAG,GAAG,IAAIG,YAAJ,CAAQQ,KAAK,CAAC,KAAD,CAAL,CAAa,CAAb,CAAR,CAAV;AACA,iBAAKpB,IAAL,CAAUI,IAAV,CAAeK,GAAf;AACD,WAHD;;AAIA,cAAI,KAAKV,QAAL,CAAcI,MAAd,KAAyB,CAA7B,EAAgC;AAC9B,iBAAKG,OAAL,CAAa,KAAKN,IAAlB;AACD,WAFD,MAEO;AACL,iBAAKQ,YAAL;AACD;AACF;;AACD,YAAIU,MAAM,CAAC,cAAD,CAAV,EAA4B;AAC1BA,UAAAA,MAAM,CAAC,cAAD,CAAN,CAAuB,SAAvB,EAAkCC,OAAlC,CAA0CC,KAAK,IAAI;AACjD,iBAAKrB,QAAL,CAAcK,IAAd,CAAmBgB,KAAK,CAAC,KAAD,CAAL,CAAa,CAAb,CAAnB;AACD,WAFD;AAGA,eAAKZ,YAAL;AACD;AACF,OAlBD;AAmBD,KArBD;AAsBD;;AAzEoC","sourcesContent":["// @flow\nimport request from \"then-request\";\nimport { parseString } from \"xml2js\";\nimport Progress from \"../Model/Progress\";\nimport Url from \"../Model/Url\";\n\n/**\n * Get all the urls from the sitemaps.\n */\nexport default class SitemapRepository {\n  /**\n   * The initial sitemap url.\n   */\n  initialUrl: string;\n  /**\n   * Array of the site maps to search. This list gets popped and will be empty.\n   */\n  sitemaps: string[];\n  /**\n   * Array of all the urls found.\n   */\n  urls: Url[];\n\n  progress: Progress => void;\n\n  resolve: (Url[]) => void;\n\n  reject: () => void;\n\n  /**\n   * Build a sitemap repository\n   */\n  constructor(initialSitemap: string) {\n    this.initialUrl = initialSitemap;\n    this.sitemaps = [];\n    this.urls = [];\n  }\n\n  /**\n   * Find all the urls on a sitemap.\n   */\n  findAllPages(progress: Progress => void): Promise<Url[]> {\n    this.progress = progress;\n    if (this.sitemaps.length === 0) {\n      this.sitemaps.push(this.initialUrl);\n    }\n    return new Promise((resolve, reject) => {\n      this.resolve = resolve;\n      this.reject = reject;\n      this.parseSiteMap();\n    });\n  }\n\n  /**\n   * Gets the sitemap, if there are more sitemaps it will add them to the list\n   * else, just adds the urls to the urls array.\n   */\n  parseSiteMap() {\n    let url = this.sitemaps.pop();\n    this.progress(new Progress(new Url(url), null, this.sitemaps.length, this.urls.length));\n    request(\"GET\", url).done(res => {\n      let xml = res.getBody(\"utf8\");\n      parseString(xml, (err, result) => {\n        if (result[\"urlset\"]) {\n          result[\"urlset\"][\"url\"].forEach(entry => {\n            let url = new Url(entry[\"loc\"][0]);\n            this.urls.push(url);\n          });\n          if (this.sitemaps.length === 0) {\n            this.resolve(this.urls);\n          } else {\n            this.parseSiteMap();\n          }\n        }\n        if (result[\"sitemapindex\"]) {\n          result[\"sitemapindex\"][\"sitemap\"].forEach(entry => {\n            this.sitemaps.push(entry[\"loc\"][0]);\n          });\n          this.parseSiteMap();\n        }\n      });\n    });\n  }\n}\n"],"file":"SitemapRepository.js"}