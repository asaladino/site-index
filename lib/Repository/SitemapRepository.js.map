{"version":3,"sources":["../../src/Repository/SitemapRepository.js"],"names":["SitemapRepository","constructor","initialSitemap","initialUrl","sitemaps","urls","findAllPages","progress","length","push","Promise","resolve","reject","parseSiteMap","url","pop","Progress","Url","done","res","xml","getBody","err","result","forEach","entry"],"mappings":"6FACA,iEACA,8BACA,mEACA,yD,kFAEA;;GAGe,KAAMA,CAAAA,iBAAkB,CACnC;;OADmC,CAKnC;;OALmC,CASnC;;OATmC,CAoBnC;;OAGAC,WAAW,CAACC,cAAD,CAAyB,CAChC,KAAKC,UAAL,CAAkBD,cAAlB,CACA,KAAKE,QAAL,CAAgB,EAAhB,CACA,KAAKC,IAAL,CAAY,EACf,CAED;;OAGAC,YAAY,CAACC,QAAD,CAA6C,CACrD,KAAKA,QAAL,CAAgBA,QAAhB,CACA,GAAI,KAAKH,QAAL,CAAcI,MAAd,GAAyB,CAA7B,CAAgC,CAC5B,KAAKJ,QAAL,CAAcK,IAAd,CAAmB,KAAKN,UAAxB,CACH,CACD,MAAO,IAAIO,CAAAA,OAAJ,CAAY,CAACC,OAAD,CAAUC,MAAV,GAAqB,CACpC,KAAKD,OAAL,CAAeA,OAAf,CACA,KAAKC,MAAL,CAAcA,MAAd,CACA,KAAKC,YAAL,EACH,CAJM,CAKV,CAED;;;OAIAA,YAAY,EAAG,CACX,GAAIC,CAAAA,GAAG,CAAG,KAAKV,QAAL,CAAcW,GAAd,EAAV,CACA,KAAKR,QAAL,CAAc,GAAIS,kBAAJ,CAAa,GAAIC,aAAJ,CAAQH,GAAR,CAAb,CAA2B,IAA3B,CAAiC,IAAjC,CAAuC,KAAKV,QAAL,CAAcI,MAArD,CAA6D,KAAKH,IAAL,CAAUG,MAAvE,CAAd,EACA,yBAAQ,KAAR,CAAeM,GAAf,EAAoBI,IAApB,CAAyBC,GAAG,EAAI,CAC5B,GAAIC,CAAAA,GAAG,CAAGD,GAAG,CAACE,OAAJ,CAAY,MAAZ,CAAV,CACA,wBAAYD,GAAZ,CAAiB,CAACE,GAAD,CAAMC,MAAN,GAAiB,CAC9B,GAAIA,MAAM,CAAC,QAAD,CAAV,CAAsB,CAClBA,MAAM,CAAC,QAAD,CAAN,CAAiB,KAAjB,EAAwBC,OAAxB,CAAgCC,KAAK,EAAI,CACrC,GAAIX,CAAAA,GAAG,CAAG,GAAIG,aAAJ,CAAQQ,KAAK,CAAC,KAAD,CAAL,CAAa,CAAb,CAAR,CAAV,CACA,KAAKpB,IAAL,CAAUI,IAAV,CAAeK,GAAf,CACH,CAHD,EAIA,GAAI,KAAKV,QAAL,CAAcI,MAAd,GAAyB,CAA7B,CAAgC,CAC5B,KAAKG,OAAL,CAAa,KAAKN,IAAlB,CACH,CAFD,IAEO,CACH,KAAKQ,YAAL,EACH,CACJ,CACD,GAAIU,MAAM,CAAC,cAAD,CAAV,CAA4B,CACxBA,MAAM,CAAC,cAAD,CAAN,CAAuB,SAAvB,EAAkCC,OAAlC,CAA0CC,KAAK,EAAI,CAC/C,KAAKrB,QAAL,CAAcK,IAAd,CAAmBgB,KAAK,CAAC,KAAD,CAAL,CAAa,CAAb,CAAnB,CACH,CAFD,EAGA,KAAKZ,YAAL,EACH,CACJ,CAlBD,CAmBH,CArBD,CAsBH,CAzEkC,C","sourcesContent":["// @flow\nimport request from \"then-request\";\nimport {parseString} from \"xml2js\";\nimport Progress from \"../Model/Progress\";\nimport Url from \"../Model/Url\";\n\n/**\n * Get all the urls from the sitemaps.\n */\nexport default class SitemapRepository {\n    /**\n     * The initial sitemap url.\n     */\n    initialUrl: string;\n    /**\n     * Array of the site maps to search. This list gets popped and will be empty.\n     */\n    sitemaps: string[];\n    /**\n     * Array of all the urls found.\n     */\n    urls: Url[];\n\n    progress: Progress => void;\n\n    resolve: (Url[]) => void;\n\n    reject: () => void;\n\n    /**\n     * Build a sitemap repository\n     */\n    constructor(initialSitemap: string) {\n        this.initialUrl = initialSitemap;\n        this.sitemaps = [];\n        this.urls = [];\n    }\n\n    /**\n     * Find all the urls on a sitemap.\n     */\n    findAllPages(progress: Progress => void): Promise<Url[]> {\n        this.progress = progress;\n        if (this.sitemaps.length === 0) {\n            this.sitemaps.push(this.initialUrl);\n        }\n        return new Promise((resolve, reject) => {\n            this.resolve = resolve;\n            this.reject = reject;\n            this.parseSiteMap();\n        });\n    }\n\n    /**\n     * Gets the sitemap, if there are more sitemaps it will add them to the list\n     * else, just adds the urls to the urls array.\n     */\n    parseSiteMap() {\n        let url = this.sitemaps.pop();\n        this.progress(new Progress(new Url(url), null, null, this.sitemaps.length, this.urls.length));\n        request(\"GET\", url).done(res => {\n            let xml = res.getBody(\"utf8\");\n            parseString(xml, (err, result) => {\n                if (result[\"urlset\"]) {\n                    result[\"urlset\"][\"url\"].forEach(entry => {\n                        let url = new Url(entry[\"loc\"][0]);\n                        this.urls.push(url);\n                    });\n                    if (this.sitemaps.length === 0) {\n                        this.resolve(this.urls);\n                    } else {\n                        this.parseSiteMap();\n                    }\n                }\n                if (result[\"sitemapindex\"]) {\n                    result[\"sitemapindex\"][\"sitemap\"].forEach(entry => {\n                        this.sitemaps.push(entry[\"loc\"][0]);\n                    });\n                    this.parseSiteMap();\n                }\n            });\n        });\n    }\n}\n"],"file":"SitemapRepository.js"}